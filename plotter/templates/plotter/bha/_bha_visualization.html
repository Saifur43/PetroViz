

{% if mode == 'a4' %}
<div class="col-lg-4">
    <div class="card position-sticky" style="top: 20px;">
        <div class="card-header text-white" style="background-color: #1353A3;">
            <h6 class="mb-0" style="font-weight:700;">
                <i class="bi bi-diagram-3 me-2"></i>BHA Visualization
            </h6>
        </div>
        <div class="card-body p-0">
            <div class="bha-a4-container" id="bha-a4-container">
                <div class="bha-visualization-wrapper">
                    <div class="bha-visualization" id="bha-visualization" data-total-length="{{ total_length|default:0 }}">
                        {% for component in components %}
                        <div class="bha-component"
                             data-length="{{ component.length }}"
                             data-od="{{ component.outer_diameter }}"
                             data-type="{{ component.component.type|default:'' }}"
                             data-position="{{ component.position }}"
                             data-name="{{ component.component.name }}">
                            <div class="component-svg">{{ component.svg|safe }}</div>
                            <div class="component-label-inline">
                                <div class="label-text">{{ component.component.name }}</div>
                                <div class="label-length">{{ component.length }} m</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <!-- Depth scale (ticks) and numeric scale box -->
                <div class="bha-depth-scale" id="bha-depth-scale"></div>
                <div class="bha-scale" id="bha-scale"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal used by detail page for add/edit component -->
<div id="component-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="component-form-container"></div>
    </div>
</div>

<style>
    /* A4 Paper Size Container (210mm x 297mm at 96 DPI) */
    .bha-a4-container {
        width: 100%;
        max-width: 794px;
        height: 1123px;
        background: #ffffff;
        overflow: hidden;
        position: relative;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .bha-visualization-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .bha-visualization {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 0;
        position: relative;
        line-height: 0;
        font-size: 0;
        width: auto; /* JS sets exact width based on max OD */
        max-width: none;
        gap: 0;
        row-gap: 0;
    }

    .bha-component {
        background: transparent;
        padding: 0;
        margin: 0;
        border: none;
        box-shadow: none;
        transition: all 0.2s;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center; /* center SVG within common track width */
        position: relative;
        cursor: pointer;
        width: 100%; /* component row width equals common track width set by JS */
        line-height: 0;
        font-size: 0;
    }

    .bha-component:hover { filter: brightness(1.1); z-index: 10; }

    .component-svg { display: block; height: 100%; width: auto; margin: 0; padding: 0; line-height: 0; font-size: 0; overflow: visible; flex-shrink: 0; min-width: 40px; }
    .component-svg svg { width: 100%; height: 100%; display: block; margin: 0; padding: 0; vertical-align: top; }

    /* Move inline component labels to the LEFT side */
    .component-label-inline { position: absolute; right: 100%; left: auto; top: 50%; transform: translateY(-50%); margin-right: 8px; background: rgba(0, 0, 0, 0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; pointer-events: none; z-index: 100; opacity: 1; transition: background 0.2s; display: flex; flex-direction: column; align-items: flex-end; line-height: 1.3; }
    .label-text { font-weight: 600; font-size: 10px; }
    .label-length { font-size: 9px; opacity: 0.9; }

    /* Depth indicator on the RIGHT side */
    .bha-depth-scale { position: absolute; right: 8px; top: 20px; bottom: 36px; width: 56px; pointer-events: none; }
    .depth-tick { position: absolute; right: 0; width: 56px; height: 1px; border-top: 1px solid rgba(0,0,0,0.25); }
    .depth-tick.major { border-top-color: rgba(0,0,0,0.45); }
    .depth-label { position: absolute; right: 0; transform: translateY(-50%); color: rgba(0,0,0,0.75); font-size: 10px; background: rgba(255,255,255,0.75); padding: 0 2px; border-radius: 2px; }

    .bha-scale { position: absolute; right: 12px; bottom: 12px; background: rgba(0,0,0,0.55); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; pointer-events: none; }

    @media (max-width: 991px) { .bha-a4-container { height: 600px; } }
    @media print { .bha-a4-container { width: 210mm; height: 297mm; } }
</style>

<script>
    // Modal behavior
    (function(){
        document.addEventListener('click', function(e){
            if (e.target && e.target.classList && e.target.classList.contains('close')) {
                document.getElementById('component-modal').style.display = 'none';
            }
        });
        window.addEventListener('click', function(event){
            const modal = document.getElementById('component-modal');
            if (modal && event.target == modal) modal.style.display = 'none';
        });
    })();

    function renderBhaVisualization() {
        const container = document.getElementById('bha-visualization');
        const a4Container = document.getElementById('bha-a4-container');
        const scaleBox = document.getElementById('bha-scale');
        if (!container || !a4Container) return;

        const components = Array.from(container.querySelectorAll('.bha-component'));
        if (!components.length) return;

        const lengths = components.map(c => parseFloat(c.dataset.length) || 0);
        const ods = components.map(c => parseFloat(c.dataset.od) || 0);

        const totalLengthAttr = parseFloat(container.dataset.totalLength);
        const totalLength = (isFinite(totalLengthAttr) && totalLengthAttr > 0)
            ? totalLengthAttr
            : lengths.reduce((s, v) => s + v, 0);

        const availableHeight = Math.max(200, a4Container.clientHeight - 40);
        const pxPerMeter = totalLength > 0 ? (availableHeight / totalLength) : 40;

        const maxOd = Math.max(...ods, 1);
        const maxSvgWidth = Math.min(300, Math.max(180, Math.floor(a4Container.clientWidth * 0.30)));
        const odScale = maxSvgWidth / maxOd;

        container.style.width = maxSvgWidth + 'px';

        components.forEach((c) => {
            const len = parseFloat(c.dataset.length) || 0.1;
            const od = parseFloat(c.dataset.od) || maxOd;
            const type = (c.dataset.type || '').toLowerCase();

            let heightPx;
            if (type === 'bit') { heightPx = 100; }
            else { heightPx = Math.max(10, Math.round(len * pxPerMeter)); }

            let widthPx;
            if (type === 'bit') { widthPx = Math.max(40, Math.round(maxSvgWidth)); }
            else {
                const blended = (0.5 * (od / maxOd) + 0.5) * maxSvgWidth;
                widthPx = Math.max(40, Math.round(blended));
            }

            c.style.height = heightPx + 'px';
            const svgBox = c.querySelector('.component-svg');
            if (svgBox) {
                svgBox.style.width = widthPx + 'px';
                svgBox.style.height = '100%';
                const svgEl = svgBox.querySelector('svg');
                if (svgEl) {
                    if (type === 'bit') svgEl.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                    else svgEl.setAttribute('preserveAspectRatio', 'none');
                    svgEl.style.width = '100%'; svgEl.style.height = '100%';
                }
            }
        });

        // Render depth ticks on the right
        const depthScale = document.getElementById('bha-depth-scale');
        if (depthScale) {
            depthScale.innerHTML = '';
            // choose a step so that we don't exceed ~20 ticks
            const candidates = [0.1, 0.2, 0.5, 1, 2, 5, 10, 20, 50];
            let step = 1;
            for (let i = 0; i < candidates.length; i++) {
                if (totalLength / candidates[i] <= 20) { step = candidates[i]; break; }
            }
            const heightStartOffset = 0; // relative to top of container content
            for (let d = 0; d <= totalLength + 1e-6; d += step) {
                const y = Math.round(heightStartOffset + d * pxPerMeter);
                const tick = document.createElement('div');
                tick.className = 'depth-tick' + ((Math.abs((d / (step * 5)) - Math.round(d / (step * 5))) < 1e-6) ? ' major' : '');
                tick.style.top = y + 'px';
                depthScale.appendChild(tick);

                // label every (step * 2) or at least every 1m
                const labelEvery = Math.max(1, step * 2);
                if (Math.abs((d / labelEvery) - Math.round(d / labelEvery)) < 1e-6 || d === 0 || Math.abs(d - totalLength) < 1e-6) {
                    const lab = document.createElement('div');
                    lab.className = 'depth-label';
                    lab.style.top = y + 'px';
                    lab.textContent = `${d.toFixed(step < 1 ? 1 : 0)} m`;
                    depthScale.appendChild(lab);
                }
            }
        }

        if (scaleBox) {
            const sampleMeters = totalLength > 0 ? Math.max(1, Math.floor(totalLength / 10)) : 1;
            const px = Math.round(sampleMeters * pxPerMeter);
            scaleBox.textContent = `Scale: 1 m = ${pxPerMeter.toFixed(1)} px  |  ${sampleMeters} m â‰ˆ ${px}px`;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        renderBhaVisualization();
        setTimeout(renderBhaVisualization, 200);
    });
    window.addEventListener('resize', renderBhaVisualization);
</script>

{% else %}
{# preview mode - redirect to separate preview template #}
{% include 'plotter/bha/_bha_visualization_preview.html' with total_length=total_length only %}
{% endif %}
