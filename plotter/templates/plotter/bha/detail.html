{# templates/plotter/bha/detail.html #}
{% extends 'plotter/bha/base_bha.html' %}

{% block bha_content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <h2 class="text-dark" style="font-weight:700;">{{ bha.name }}</h2>
    </div>
</div>

<div class="row">
    <!-- Left Column: Information -->
    <div class="col-lg-8">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Well Name</h6>
                        <h4 class="card-text mb-1">{{ bha.drilling_report.well.name }}</h4>
                        <small class="text-muted">{{ bha.drilling_report.date|date:"Y-m-d" }}</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Total Length</h6>
                        <h4 class="card-text mb-1">{{ bha.total_length|floatformat:2 }} m</h4>
                        <small class="text-muted">Total assembly length</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Total Weight</h6>
                        <h4 class="card-text mb-1">{{ bha.total_weight|floatformat:2 }} kg</h4>
                        <small class="text-muted">Total assembly weight</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="card-title text-muted">Status</h6>
                        <h4 class="card-text mb-1">
                            {% if bha.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </h4>
                        <small class="text-muted">Current state</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Components Table -->
        <div class="card">
            <div class="card-header text-white" style="background-color: #1353A3;">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" style="font-weight:700;">
                        <i class="bi bi-list-check me-2"></i>Components
                    </h5>
                    <div>
                        <a href="{% url 'bha_edit_designer' bha.id %}" class="btn btn-light btn-sm">
                            <i class="bi bi-pencil-square me-1"></i>Edit / Add Components
                        </a>
                        <a href="{% url 'bha_export_pdf' bha.id %}" class="btn btn-outline-secondary btn-sm ms-2">
                            <i class="bi bi-filetype-pdf me-1"></i>Export PDF
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Component</th>
                                <th>Type</th>
                                <th>Length (m)</th>
                                <th>OD (in)</th>
                                <th>From Bit (m)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for component in components %}
                            <tr>
                                <td>{{ component.position }}</td>
                                <td><strong>{{ component.component.name }}</strong></td>
                                <td><small>{{ component.component.get_type_display }}</small></td>
                                <td>{{ component.length|floatformat:2 }}</td>
                                <td>{{ component.outer_diameter|floatformat:2 }}</td>
                                <td>{{ component.distance_from_bit|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: BHA Visualization (A4 Size) -->
    <div class="col-lg-4">
        <div class="card position-sticky" style="top: 20px;">
            <div class="card-header text-white" style="background-color: #1353A3;">
                <h6 class="mb-0" style="font-weight:700;">
                    <i class="bi bi-diagram-3 me-2"></i>BHA Visualization
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="bha-a4-container" id="bha-a4-container">
                    <div class="bha-visualization-wrapper">
                        <div class="bha-visualization" id="bha-visualization" data-total-length="{{ bha.total_length|default:total_length }}">
                            {% for component in components %}
                       <div class="bha-component" 
                           data-length="{{ component.length }}"
                           data-od="{{ component.outer_diameter }}"
                           data-position="{{ component.position }}"
                           data-name="{{ component.component.name }}"
                           data-type="{{ component.component.type }}"
                           title="{{ component.component.name }}">
                                <div class="component-svg">
                                    {{ component.svg|safe }}
                                </div>
                                <div class="component-label-inline">
                                    <span class="label-text">{{ component.component.name }}</span>
                                    <span class="label-length">{{ component.length|floatformat:1 }}m</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                   <!-- <div class="bha-scale" id="bha-scale" aria-hidden="true"></div> --->
                </div>
            </div>
        </div>
    </div>
</div>

<div id="component-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="component-form-container"></div>
    </div>
</div>

{% block extra_css %}
<style>
    /* A4 Paper Size Container (210mm x 297mm at 96 DPI) */
    .bha-a4-container {
        width: 100%;
        max-width: 794px;
        height: 1123px;
        background: #ffffff;
        overflow: hidden;
        position: relative;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .bha-visualization-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .bha-visualization {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0;
        padding: 0;
        position: relative;
        line-height: 0;
        font-size: 0;
        width: auto; /* JS sets exact width based on max OD */
        max-width: none;
    }

    .bha-component {
        background: transparent;
        padding: 0;
        margin: 0;
        border: none;
        box-shadow: none;
        transition: all 0.2s;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center; /* center SVG within common track width */
        position: relative;
        cursor: pointer;
        width: 100%; /* component row width equals common track width set by JS */
        line-height: 0;
        font-size: 0;
    }

    .bha-component:hover {
        filter: brightness(1.1);
        z-index: 10;
    }

    .bha-component:hover .component-label-inline {
        opacity: 1;
        background: rgba(19, 83, 163, 0.95);
        color: white;
    }

    .component-svg {
        display: block;
        height: 100%;
        width: auto;
        margin: 0;
        padding: 0;
        line-height: 0;
        font-size: 0;
        overflow: visible;
        flex-shrink: 0;
        min-width: 40px; /* thicker minimum */
    }

    .component-svg svg {
        width: 100%;
        height: 100%;
        display: block;
        margin: 0;
        padding: 0;
        vertical-align: top;
    }

    .component-label-inline {
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        margin-left: 8px;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        pointer-events: none;
        z-index: 100;
        opacity: 1;
        transition: background 0.2s;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        line-height: 1.3;
    }

    .label-text {
        font-weight: 600;
        font-size: 10px;
    }

    .bha-scale {
        position: absolute;
        right: 12px;
        bottom: 12px;
        background: rgba(0,0,0,0.55);
        color: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        pointer-events: none;
    }

    .label-length {
        font-size: 9px;
        opacity: 0.9;
    }

    .stats-card {
        animation: cardSlideIn 0.5s ease-out;
        border-left: 3px solid #1353A3;
    }

    .stats-card .card-body {
        padding: 1rem;
    }

    @keyframes cardSlideIn {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .table thead th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .table tbody tr {
        transition: background-color 0.2s;
        font-size: 0.875rem;
    }

    .table tbody tr:hover {
        background-color: rgba(19, 83, 163, 0.05);
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
        background-color: #ffffff;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        width: 90%;
        max-width: 600px;
        animation: slideIn 0.3s ease-out;
    }

    .close {
        float: right;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6c757d;
        transition: color 0.2s;
    }

    .close:hover {
        color: #343a40;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    @media (max-width: 991px) {
        .bha-a4-container {
            height: 600px;
        }
    }

    @media print {
        .bha-a4-container {
            width: 210mm;
            height: 297mm;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    function addComponent() {
        const modal = document.getElementById('component-modal');
        const formContainer = document.getElementById('component-form-container');
        
        fetch(`/bha/{{ bha.id }}/add-component/`)
            .then(response => response.json())
            .then(data => {
                formContainer.innerHTML = data.form_html;
                modal.style.display = 'block';
            });
    }

    document.querySelector('.close').onclick = function() {
        document.getElementById('component-modal').style.display = 'none';
    }

    window.onclick = function(event) {
        const modal = document.getElementById('component-modal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    
    function renderBhaVisualization() {
    const container = document.getElementById('bha-visualization');
    const a4Container = document.getElementById('bha-a4-container');
    const scaleBox = document.getElementById('bha-scale');
    
    if (!container || !a4Container) return;

    const components = Array.from(container.querySelectorAll('.bha-component'));
    
    if (!components.length) return;

    const lengths = components.map(c => parseFloat(c.dataset.length) || 0);
    const ods = components.map(c => parseFloat(c.dataset.od) || 0);

    const totalLengthAttr = parseFloat(container.dataset.totalLength);
    const totalLength = (isFinite(totalLengthAttr) && totalLengthAttr > 0)
        ? totalLengthAttr
        : lengths.reduce((s, v) => s + v, 0);

    // Use actual container height so it always fits on screen and prints to A4
    const availableHeight = Math.max(200, a4Container.clientHeight - 40);
    const pxPerMeter = totalLength > 0 ? (availableHeight / totalLength) : 40;

    const maxOd = Math.max(...ods, 1);
    const maxSvgWidth = Math.min(300, Math.max(180, Math.floor(a4Container.clientWidth * 0.30)));
    const odScale = maxSvgWidth / maxOd;

    // Set a common track width so varying OD components are centered consistently
    container.style.width = maxSvgWidth + 'px';

    components.forEach((c, index) => {
        const len = parseFloat(c.dataset.length) || 0.1;
        const od = parseFloat(c.dataset.od) || maxOd;
        const type = (c.dataset.type || '').toLowerCase();

        // For drill bits: use a fixed, reasonable height to preserve aspect ratio
        let heightPx;
        if (type === 'bit') {
            // Fixed height for drill bits (adjust this value as needed, e.g., 80-120px)
            heightPx = 100;
        } else {
            heightPx = Math.max(10, Math.round(len * pxPerMeter));
        }
        
        // For drill bits, use the full SVG width so the bit renders clearly
        let widthPx;
        if (type === 'bit') {
            widthPx = Math.max(40, Math.round(maxSvgWidth));
        } else {
            // Thicker: ensure >= 50% of max width while preserving OD differences
            const blended = (0.5 * (od / maxOd) + 0.5) * maxSvgWidth;
            widthPx = Math.max(40, Math.round(blended));
        }

        c.style.height = heightPx + 'px';
        c.style.margin = '0';
        c.style.padding = '0';
        c.style.flexShrink = '0';
        c.style.lineHeight = '0';
        c.style.fontSize = '0';
        c.style.display = 'flex';

        const svgBox = c.querySelector('.component-svg');
        if (svgBox) {
            svgBox.style.width = widthPx + 'px';
            svgBox.style.height = '100%';
            svgBox.style.lineHeight = '0';
            svgBox.style.fontSize = '0';
            svgBox.style.display = 'block';
            svgBox.style.margin = '0 auto';

            const svgEl = svgBox.querySelector('svg');
            if (svgEl) {
                // For drill bits: preserve aspect ratio; for others: stretch to fill
                if (type === 'bit') {
                    svgEl.setAttribute('preserveAspectRatio', 'xMidYMid meet');
                } else {
                    svgEl.setAttribute('preserveAspectRatio', 'none');
                }
                
                svgEl.style.width = '100%';
                svgEl.style.height = '100%';
                svgEl.style.display = 'block';
                svgEl.style.verticalAlign = 'top';
                svgEl.style.margin = '0';
                svgEl.style.padding = '0';
            }
        }
    });

    if (scaleBox) {
        const sampleMeters = totalLength > 0 ? Math.max(1, Math.floor(totalLength / 10)) : 1;
        const px = Math.round(sampleMeters * pxPerMeter);
        scaleBox.textContent = `Scale: 1 m = ${pxPerMeter.toFixed(1)} px  |  ${sampleMeters} m â‰ˆ ${px}px`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    renderBhaVisualization();
    setTimeout(renderBhaVisualization, 200);
});

window.addEventListener('resize', function() {
    renderBhaVisualization();
});
</script>
{% endblock %}
{% endblock %}