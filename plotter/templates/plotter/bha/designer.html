{% extends 'plotter/bha/base_bha.html' %}

{% block bha_content %}
<div class="row">
    <div class="col-md-12 mb-3">
        <div class="designer-header">
            <h2 class="mb-2"><i class="bi bi-tools me-2"></i>BHA Designer</h2>
            <p class="mb-0 opacity-90">Create and configure your Bottom Hole Assembly with drag-and-drop functionality</p>
        </div>
    </div>
</div>

<form method="post" id="designer-form">
    {% csrf_token %}
    
    <div class="row">
        <!-- Left Column: Designer Form -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <!-- BHA Information -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold"><i class="bi bi-tag me-1"></i>BHA Name *</label>
                            <input type="text" name="bha_name" class="form-control" placeholder="e.g., 8-1/2 inch BHA" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold"><i class="bi bi-file-text me-1"></i>Drilling Report *</label>
                            <select name="report_id" class="form-select" required>
                                <option value="">Select drilling report</option>
                                {% for r in reports %}
                                <option value="{{ r.id }}">{{ r.well.name }} â€” {{ r.date|date:'Y-m-d' }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold"><i class="bi bi-pencil me-1"></i>Notes</label>
                            <input type="text" name="bha_text" class="form-control" placeholder="Optional notes">
                        </div>
                    </div>

                    <!-- Components Table -->
                    <div class="table-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-list-ol me-2"></i>Components</h5>
                            <button type="button" class="btn btn-add-row btn-sm" id="add-row">
                                <i class="bi bi-plus-circle me-1"></i>Add Component
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="designer-table">
                                <thead>
                                    <tr>
                                        <th style="width:3%"></th>
                                        <th style="width:3%">#</th>
                                        <th style="width:25%">Component</th>
                                        <th style="width:8%">Count</th>
                                        <th style="width:11%">OD (in)</th>
                                        <th style="width:11%">Length (m)</th>
                                        <th style="width:11%">Weight (kg)</th>
                                        <th style="width:11%">Total (m)</th>
                                        <th style="width:14%">Notes</th>
                                        <th style="width:3%"></th>
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <!-- Rows will be added here -->
                                </tbody>
                            </table>
                        </div>

                        <div id="empty-state" class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>No components added yet. Click "Add Component" to get started.</p>
                        </div>
                    </div>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="total-box">
                                    <div class="total-label">Components</div>
                                    <div class="total-value" id="total-components">0</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="total-box">
                                    <div class="total-label">Total Length</div>
                                    <div class="total-value" id="total-length">0.00 m</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="total-box">
                                    <div class="total-label">Total Weight</div>
                                    <div class="total-value" id="total-weight">0.00 kg</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="total-box">
                                    <div class="total-label">Avg OD</div>
                                    <div class="total-value" id="avg-od">0.00 in</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <a href="{% url 'bha_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Cancel
                        </a>
                        <button type="button" class="btn btn-outline-primary" id="clear-all">
                            <i class="bi bi-trash me-1"></i>Clear All
                        </button>
                        <button type="submit" class="btn btn-primary ms-auto">
                            <i class="bi bi-check-circle me-1"></i>Create BHA
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% include 'plotter/bha/_bha_visualization_preview.html' with total_length=0 only %}
    </div>
</form>

<!-- Toast Notification -->
<div class="toast-notification" id="toast-container"></div>


<style>
    :root {
        --primary-color: #1353A3;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --border-radius: 8px;
    }

    body {
        background-color: #f8f9fa;
    }

    .designer-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #0d3d73 100%);
        color: white;
        padding: 1rem;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }

    .table-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
    }

    #designer-table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-bottom: 2px solid var(--primary-color);
        font-size: 0.875rem;
        padding: 0.75rem 0.5rem;
        white-space: nowrap;
    }

    #designer-table tbody tr {
        transition: all 0.2s ease;
        cursor: move;
    }

    #designer-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    #designer-table tbody tr.dragging {
        opacity: 0.5;
        background-color: #e3f2fd;
    }

    #designer-table tbody tr.drag-over {
        border-top: 3px solid var(--primary-color);
    }

    .drag-handle {
        cursor: move;
        color: #6c757d;
        font-size: 1.2rem;
        padding: 0.5rem;
        transition: color 0.2s;
    }

    .drag-handle:hover {
        color: var(--primary-color);
    }

    .row-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        font-weight: 600;
        font-size: 0.75rem;
    }

    .btn-remove {
        transition: all 0.2s;
    }

    .btn-remove:hover {
        transform: scale(1.1);
        background-color: var(--danger-color);
        color: white;
    }

    .totals-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-top: 1rem;
    }

    .total-box {
        background: white;
        padding: 1rem;
        border-radius: 6px;
        border-left: 4px solid var(--primary-color);
    }

    .total-label {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .total-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-top: 0.25rem;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .btn {
        border-radius: 6px;
        padding: 0.625rem 1.5rem;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background-color: #0d3d73;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(19, 83, 163, 0.3);
    }

    .btn-add-row {
        background-color: var(--success-color);
        color: white;
        border: none;
    }

    .btn-add-row:hover {
        background-color: #218838;
    }

    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .validation-error {
        border: 2px solid var(--danger-color) !important;
        animation: shake 0.3s;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    .toast-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    }

</style>

<script>
    // Component library from Django
    const components = [
        {% for c in components %}
        { 
            id: {{ c.id }}, 
            name: "{{ c.name }}", 
            type: "{{ c.type }}",
            svg_template: `{{ c.svg_template|escapejs }}`
        },
        {% endfor %}
    ];

    let rowCounter = 0;
    let draggedRow = null;

    const tableBody = document.getElementById('table-body');
    const emptyState = document.getElementById('empty-state');
    const addRowBtn = document.getElementById('add-row');
    const clearAllBtn = document.getElementById('clear-all');
    const designerForm = document.getElementById('designer-form');

    // Create component options HTML
    function getComponentOptions() {
        return components.map(c => 
            `<option value="${c.id}" data-type="${c.type}">${c.name}</option>`
        ).join('');
    }


    // Create a new row
    function createRow() {
        rowCounter++;
        const row = document.createElement('tr');
        row.draggable = true;
        row.dataset.rowId = rowCounter;
        row.innerHTML = `
            <td class="text-center">
                <i class="bi bi-grip-vertical drag-handle"></i>
            </td>
            <td class="text-center">
                <span class="row-number">${rowCounter}</span>
            </td>
            <td>
                <select class="form-select form-select-sm js-component" name="row_component" required>
                    <option value="">Select component</option>
                    ${getComponentOptions()}
                </select>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm js-singles" name="row_singles" value="1" min="1" required>
            </td>
            <td>
                <input type="number" step="0.01" class="form-control form-control-sm js-od" name="row_od" placeholder="0.00">
            </td>
            <td>
                <input type="number" step="0.01" class="form-control form-control-sm js-length" name="row_length" placeholder="0.00">
            </td>
            <td>
                <input type="number" step="0.01" class="form-control form-control-sm js-weight" name="row_weight" placeholder="0.00">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm js-row-total" value="0.00" readonly>
            </td>
            <td>
                <input type="text" class="form-control form-control-sm" name="row_text" placeholder="Optional">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger btn-remove" title="Remove row">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        // Add drag event listeners
        row.addEventListener('dragstart', handleDragStart);
        row.addEventListener('dragend', handleDragEnd);
        row.addEventListener('dragover', handleDragOver);
        row.addEventListener('drop', handleDrop);
        row.addEventListener('dragleave', handleDragLeave);
        
        return row;
    }

    // Add new row
    function addRow() {
        const row = createRow();
        tableBody.appendChild(row);
        updateEmptyState();
        updateRowNumbers();
        recalculate();
        updateBHAViewer();
        
        row.querySelector('.js-component').focus();
        showToast('Component row added', 'success');
    }

    // Remove row
    function removeRow(btn) {
        const row = btn.closest('tr');
        row.style.animation = 'fadeOut 0.3s';
        setTimeout(() => {
            row.remove();
            updateEmptyState();
            updateRowNumbers();
            recalculate();
            updateBHAViewer();
            showToast('Component removed', 'info');
        }, 300);
    }

    // Update row numbers
    function updateRowNumbers() {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            const numberSpan = row.querySelector('.row-number');
            if (numberSpan) {
                numberSpan.textContent = index + 1;
            }
        });
    }

    // Update empty state visibility
    function updateEmptyState() {
        const hasRows = tableBody.querySelectorAll('tr').length > 0;
        emptyState.style.display = hasRows ? 'none' : 'block';
        document.querySelector('.table-responsive').style.display = hasRows ? 'block' : 'none';
    }

    // Recalculate totals
    function recalculate() {
        let totalLen = 0;
        let totalW = 0;
        let totalOd = 0;
        let odCount = 0;
        let componentCount = 0;

        tableBody.querySelectorAll('tr').forEach(row => {
            const singles = parseFloat(row.querySelector('.js-singles').value) || 0;
            const length = parseFloat(row.querySelector('.js-length').value) || 0;
            const weight = parseFloat(row.querySelector('.js-weight').value) || 0;
            const od = parseFloat(row.querySelector('.js-od').value) || 0;
            
            const rowTotal = singles * length;
            row.querySelector('.js-row-total').value = rowTotal.toFixed(2);
            
            totalLen += rowTotal;
            totalW += singles * weight;
            
            if (od > 0) {
                totalOd += od;
                odCount++;
            }
            
            if (singles > 0) componentCount++;
        });

        document.getElementById('total-components').textContent = componentCount;
        document.getElementById('total-length').textContent = totalLen.toFixed(2) + ' m';
        document.getElementById('total-weight').textContent = totalW.toFixed(2) + ' kg';
        document.getElementById('avg-od').textContent = odCount > 0 ? (totalOd / odCount).toFixed(2) + ' in' : '0.00 in';
    }

    // Update BHA Viewer using shared function from _bha_visualization.html
    function updateBHAViewer() {
        const rows = tableBody.querySelectorAll('tr');
        const componentData = [];

        rows.forEach(row => {
            const componentSelect = row.querySelector('.js-component');
            const componentId = componentSelect.value;
            if (!componentId) return;

            const component = components.find(c => c.id == componentId);
            if (!component) return;

            const singles = parseInt(row.querySelector('.js-singles').value) || 1;
            const length = parseFloat(row.querySelector('.js-length').value) || 0;
            const od = parseFloat(row.querySelector('.js-od').value) || 0;

            for (let i = 0; i < singles; i++) {
                componentData.push({
                    id: componentId,
                    name: component.name,
                    type: component.type,
                    length: length,
                    od: od
                });
            }
        });

        // Use shared function from _bha_visualization.html
        if (typeof updateBHAViewerPreview === 'function') {
            updateBHAViewerPreview(componentData, components);
        }
    }

    // Drag and drop handlers
    function handleDragStart(e) {
        draggedRow = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd(e) {
        this.classList.remove('dragging');
        tableBody.querySelectorAll('tr').forEach(row => {
            row.classList.remove('drag-over');
        });
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        
        if (this !== draggedRow) {
            this.classList.add('drag-over');
        }
        return false;
    }

    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }

        if (draggedRow !== this) {
            const allRows = Array.from(tableBody.querySelectorAll('tr'));
            const draggedIndex = allRows.indexOf(draggedRow);
            const targetIndex = allRows.indexOf(this);

            if (draggedIndex < targetIndex) {
                this.parentNode.insertBefore(draggedRow, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedRow, this);
            }
            
            updateRowNumbers();
            updateBHAViewer();
            showToast('Component reordered', 'success');
        }

        return false;
    }

    // Clear all rows
    function clearAll() {
        if (confirm('Are you sure you want to remove all components?')) {
            tableBody.innerHTML = '';
            rowCounter = 0;
            updateEmptyState();
            recalculate();
            updateBHAViewer();
            showToast('All components cleared', 'warning');
        }
    }

    // Show toast notification
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show`;
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.getElementById('toast-container');
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 150);
        }, 3000);
    }

    // Form validation
    function validateForm() {
        const bhaName = document.querySelector('[name="bha_name"]');
        const reportId = document.querySelector('[name="report_id"]');
        const rows = tableBody.querySelectorAll('tr');

        if (!bhaName.value.trim()) {
            bhaName.classList.add('validation-error');
            showToast('BHA name is required', 'danger');
            bhaName.focus();
            return false;
        }

        if (!reportId.value) {
            reportId.classList.add('validation-error');
            showToast('Drilling report is required', 'danger');
            reportId.focus();
            return false;
        }

        if (rows.length === 0) {
            showToast('Please add at least one component', 'danger');
            return false;
        }

        let hasError = false;
        rows.forEach(row => {
            const component = row.querySelector('.js-component');
            if (!component.value) {
                component.classList.add('validation-error');
                hasError = true;
            }
        });

        if (hasError) {
            showToast('Please select a component for all rows', 'danger');
            return false;
        }

        return true;
    }

    // Event listeners
    addRowBtn.addEventListener('click', addRow);
    clearAllBtn.addEventListener('click', clearAll);

    tableBody.addEventListener('input', (e) => {
        if (e.target.matches('.js-singles, .js-length, .js-weight, .js-od')) {
            recalculate();
            updateBHAViewer();
        }
        if (e.target.matches('.js-component')) {
            updateBHAViewer();
        }
        // Remove validation error on input
        e.target.classList.remove('validation-error');
    });

    tableBody.addEventListener('change', (e) => {
        if (e.target.matches('.js-component')) {
            updateBHAViewer();
        }
    });

    tableBody.addEventListener('click', (e) => {
        if (e.target.closest('.btn-remove')) {
            removeRow(e.target.closest('.btn-remove'));
        }
    });

    designerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        if (validateForm()) {
            showToast('Creating BHA...', 'success');
            // Submit the form
            designerForm.submit();
        }
    });

    // Remove validation errors on change
    document.querySelectorAll('.form-control, .form-select').forEach(input => {
        input.addEventListener('input', () => {
            input.classList.remove('validation-error');
        });
    });

    // Initialize
    updateEmptyState();
    updateBHAViewer();
    
    // Add initial row for convenience
    addRow();
</script>
{% endblock %}