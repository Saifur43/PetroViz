{% if prognosis_segments %}
<script>
(function(){
    const wrap = document.getElementById('prognosis-wrap');
    const bar = document.getElementById('prognosis-bar');
    const ticks = document.getElementById('prognosis-ticks');
    const reportsContainer = document.getElementById('reports-container');
    const chip = document.getElementById('prognosis-filter-chip');
    const chipLabel = document.getElementById('filter-label');
    const btnClear = document.getElementById('btn-clear-filter');
    const btnExpandAll = document.getElementById('btn-expand-all');
    const btnCollapseAll = document.getElementById('btn-collapse-all');
    if (!bar) return;
    
    bar.querySelectorAll('.prognosis-spacer, .prognosis-segment').forEach(el => {
        const h = parseFloat(el.getAttribute('data-height'));
        if (!isNaN(h)) el.style.height = h + '%';
        const color = el.getAttribute('data-color');
        if (color) el.style.background = color;
    });

    function computeBarHeight() {
        try {
            const card = bar.closest('.card');
            const rectTop = card.getBoundingClientRect().top;
            const topOffset = Math.max(rectTop, 0);
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            const targetHeight = Math.max(viewportHeight - 24 - (rectTop - topOffset), 280);
            bar.style.height = targetHeight + 'px';
            if (ticks) ticks.style.height = targetHeight + 'px';
        } catch(e) { /* noop */ }
    }

    function niceStep(max) {
        if (!max || max <= 0) return 50;
        const raw = max / 12;
        const candidates = [10, 20, 25, 50, 100, 200, 250, 500, 1000];
        let best = candidates[0];
        for (const c of candidates) {
            if (raw <= c) { best = c; break; }
            best = c;
        }
        return best;
    }

    function buildTicks() {
        if (!ticks) return;
        const min = parseFloat(ticks.getAttribute('data-min')) || 0;
        const max = parseFloat(ticks.getAttribute('data-max')) || 0;
        const step = niceStep(max);
        const labels = [];
        const start = Math.max(0, Math.floor(min / step) * step);
        for (let v = start; v <= max; v += step) labels.push(v);
        if (labels[0] !== 0) labels.unshift(0);
        if (labels[labels.length - 1] !== max) labels.push(max);
        ticks.innerHTML = '';
        labels.forEach((value, idx) => {
            const row = document.createElement('div');
            row.className = 'prognosis-tick';
            const line = document.createElement('span');
            line.className = 'prognosis-tick-line';
            const label = document.createElement('span');
            label.textContent = value + ' m';
            row.appendChild(line);
            row.appendChild(label);
            ticks.appendChild(row);
        });
    }

    function renderLatestDepthMarker() {
        const latestAttr = bar.getAttribute('data-latest-depth');
        if (!latestAttr || !ticks) return;
        const latest = parseFloat(latestAttr);
        const max = parseFloat(ticks.getAttribute('data-max')) || 0;
        if (!max || isNaN(latest)) return;
        const clamped = Math.max(0, Math.min(latest, max));
        const pct = (clamped / max) * 100;

        let marker = bar.querySelector('.prognosis-marker');
        let label = bar.querySelector('.prognosis-marker-label');
        if (!marker) {
            marker = document.createElement('div');
            marker.className = 'prognosis-marker';
            bar.appendChild(marker);
        }
        if (!label) {
            label = document.createElement('div');
            label.className = 'prognosis-marker-label';
            bar.appendChild(label);
        }
        marker.style.top = pct + '%';
        label.style.top = pct + '%';
        label.textContent = 'Latest depth: ' + clamped.toFixed(1) + ' m';
    }

    function applyFilter(range) {
        if (!reportsContainer) return;
        const { from, to } = range;
        const cards = reportsContainer.querySelectorAll('.report-card');
        let visibleCount = 0;
        cards.forEach(card => {
            const ds = parseFloat(card.getAttribute('data-depth-start'));
            const de = parseFloat(card.getAttribute('data-depth-end'));
            const overlaps = !isNaN(ds) && !isNaN(de) && Math.max(ds, from) <= Math.min(de, to);
            card.style.display = overlaps ? '' : 'none';
            if (overlaps) visibleCount++;
        });
        if (chip) {
            if (visibleCount > 0) {
                chip.style.display = 'inline-flex';
                if (chipLabel) chipLabel.textContent = `Depth ${from.toFixed(1)}–${to.toFixed(1)} m`;
            } else {
                chip.style.display = 'inline-flex';
                if (chipLabel) chipLabel.textContent = `No reports in ${from.toFixed(1)}–${to.toFixed(1)} m`;
            }
        }
    }

    function clearFilter() {
        if (!reportsContainer) return;
        reportsContainer.querySelectorAll('.report-card').forEach(card => { card.style.display = ''; });
        bar.querySelectorAll('.prognosis-segment.active').forEach(s => s.classList.remove('active'));
        if (chip) chip.style.display = 'none';
    }

    function wireInteractions() {
        bar.querySelectorAll('.prognosis-segment').forEach(seg => {
            seg.setAttribute('tabindex', '0');
            seg.addEventListener('click', () => {
                const active = seg.classList.toggle('active');
                if (active) {
                    bar.querySelectorAll('.prognosis-segment').forEach(s => { if (s !== seg) s.classList.remove('active'); });
                    const from = parseFloat(seg.getAttribute('data-from'));
                    const to = parseFloat(seg.getAttribute('data-to'));
                    if (!isNaN(from) && !isNaN(to)) applyFilter({ from, to });
                } else {
                    clearFilter();
                }
            });
            seg.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); seg.click(); }
            });
        });
        if (btnClear) btnClear.addEventListener('click', clearFilter);
        if (btnExpandAll) btnExpandAll.addEventListener('click', () => {
            window.__bulkOp = true;
            document.querySelectorAll('.report-card').forEach(c => {
                if (!c.classList.contains('expanded')) c.querySelector('.card-header').click();
            });
            setTimeout(() => { window.__bulkOp = false; }, 0);
        });
        if (btnCollapseAll) btnCollapseAll.addEventListener('click', () => {
            window.__bulkOp = true;
            document.querySelectorAll('.report-card.expanded .card-header').forEach(h => h.click());
            setTimeout(() => { window.__bulkOp = false; }, 0);
        });
    }

    computeBarHeight();
    buildTicks();
    renderLatestDepthMarker();
    wireInteractions();
    window.addEventListener('resize', () => {
        computeBarHeight();
        renderLatestDepthMarker();
    });
})();
</script>
{% endif %}