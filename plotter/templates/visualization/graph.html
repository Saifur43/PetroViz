{% extends 'base.html' %}

{% block title %}Core Data Visualization{% endblock %}

{% block content %}
<style>
    .container-fluid {
        height: 100vh;
        display: flex;
        flex-direction: column;
        padding: 0;
    }
    .content-row {
        display: flex;
        flex-grow: 1;
        height: 100%;
        margin: 0;
    }
    .sidebar {
        width: 20%;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
        padding: 15px;
    }
    .graph-container {
        width: 26.67%; /* 80% / 3 sections = 26.67% each */
        padding: 10px;
    }
    .image-container {
        width: 26.67%; /* 80% / 3 sections = 26.67% each */
        padding: 10px;
    }
    .card {
        height: 100%;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    .image-container img {
        max-height: 100%;
        max-width: 100%;
        object-fit: cover;
    }
    .sidebar .card {
        border: none;
        background: transparent;
    }
    .sidebar .card-body {
        padding: 15px 0;
    }
</style>

<div class="container-fluid">
    <div class="content-row">
        <!-- Sidebar (20%) -->
        <div class="sidebar">
            <div class="card">
                <div class="card-header text-white" style="background-color: #F59E0B; border-radius: 8px 8px 0 0;">
                    <h5 class="mb-0">Selection Controls</h5>
                </div>
                <div class="card-body">
                    <form method="GET">
                        <div class="mb-3">
                            <label class="form-label">Select Well</label>
                            <select name="well_name" class="form-select" onchange="this.form.submit()">
                                <option value="">Choose Well</option>
                                {% for well in well_names %}
                                <option value="{{ well }}" {% if well == selected_well %}selected{% endif %}>{{ well }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        {% if selected_well %}
                        <div class="mb-3">
                            <label class="form-label">Select Core</label>
                            <select name="core_no" class="form-select" onchange="this.form.submit()">
                                <option value="">Choose Core</option>
                                {% for core in core_numbers %}
                                <option value="{{ core }}" {% if core|stringformat:"i" == selected_core %}selected{% endif %}>
                                    Core {{ core }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="d-grid">
                            <a href="{% url 'graph_view' %}" class="btn btn-primary">Clear Selection</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% if selected_well and selected_core %}
        <!-- Graph Container (26.67%) -->
        <div class="graph-container">
            <div class="card">
                <div class="card-header text-white" style="background-color: #F59E0B;">
                    <h5 class="mb-0">Core Analysis: {{ selected_well }} - Core {{ selected_core }}</h5>
                </div>
                <div class="card-body">
                    <div style="height: calc(100vh - 200px); width: 100%;">
                        <canvas id="coreDataChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Core Image (26.67%) -->
        <div class="image-container">
            <div class="card">
                <div class="card-header text-white" style="background-color: #F59E0B;">
                    <h5 class="mb-0">Core Image</h5>
                </div>
                <div class="card-body d-flex align-items-stretch justify-content-center" style="height: calc(100vh - 200px);">
                    {% if core_img_url %}
                    <img src="{{ core_img_url }}" alt="Core Image" style="max-height: 100%; max-width: 100%; object-fit: contain;">
                    {% else %}
                    <div class="d-flex align-items-center justify-content-center w-100">
                        <p class="text-muted">No core image available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Litho Image (26.67%) -->
        <div class="image-container">
            <div class="card">
                <div class="card-header text-white" style="background-color: #F59E0B;">
                    <h5 class="mb-0">Litho Image</h5>
                </div>
                <div class="card-body d-flex align-items-stretch justify-content-center" style="height: calc(100vh - 200px);">
                    {% if litho_image_url %}
                    <img src="{{ litho_image_url }}" alt="Litho Image" style="max-height: 100%; max-width: 100%; object-fit: contain;">
                    {% else %}
                    <div class="d-flex align-items-center justify-content-center w-100">
                        <p class="text-muted">No litho image available</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {% else %}
        <div class="col text-center d-flex align-items-center justify-content-center">
            <h3 class="text-muted">Please select a well and core to view data</h3>
        </div>
        {% endif %}
    </div>
</div>

{% if selected_well and selected_core %}
<script>
    const ctx = document.getElementById('coreDataChart').getContext('2d');
    const chartData = {{ chart_data|safe }};
    
    // Calculate depth range for scaling
    const depthMin = Math.min(...chartData.depths);
    const depthMax = Math.max(...chartData.depths);
    const depthPadding = (depthMax - depthMin) * 0.01;
    
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Porosity (%)',
                data: chartData.depths.map((depth, i) => ({
                    x: chartData.porosity[i],
                    y: depth
                })),
                yAxisID: 'y',
                xAxisID: 'x1',
                backgroundColor: '#1353A3',
                borderColor: '#1353A3',
                pointRadius: 4,
                showLine: true,
                borderWidth: 1
            }, {
                label: 'Permeability (mD)',
                data: chartData.depths.map((depth, i) => ({
                    x: chartData.permeability[i],
                    y: depth
                })),
                yAxisID: 'y',
                xAxisID: 'x2',
                backgroundColor: '#CA7007',
                borderColor: '#CA7007',
                pointRadius: 4,
                showLine: true,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'nearest',
                intersect: false,
            },
            scales: {
                y: {
                    reverse: true,
                    min: depthMin - depthPadding,
                    max: depthMax + depthPadding,
                    title: {
                        display: true,
                        text: 'Depth (m)',
                        font: { size: 14, weight: 'bold' }
                    },
                    grid: { color: '#ddd' }
                },
                x1: {
                    type: 'linear',
                    position: 'top',
                    title: { display: true, text: 'Porosity (%)' },
                    ticks: { color: '#1353A3' }
                },
                x2: {
                    type: 'logarithmic',
                    position: 'bottom',
                    title: { display: true, text: 'Permeability (mD)' },
                    ticks: { color: '#CA7007' }
                }
            }
        }
    });
</script>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}