{% extends 'base.html' %}

{% block title %}Core Data Visualization{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar p-3" style="background-color: #257358; color: white; min-height: 100vh;">
            <div class="card-header text-white" style="background-color: #257358; border-radius: 8px 8px 0 0; padding: 10px;">
                <h5 class="mb-0" style="color: #E98108;">Selection Controls</h5>
            </div>
                <form method="GET">
                    <div class="mb-3">
                        <label class="form-label" style="color: white;">Select Well</label>
                        <select name="well_name" class="form-select" onchange="this.form.submit()">
                            <option value="">Choose Well</option>
                            {% for well in well_names %}
                            <option value="{{ well }}" {% if well == selected_well %}selected{% endif %}>{{ well }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    {% if selected_well %}
                    <div class="mb-3">
                        <label class="form-label" style="color: white;">Select Core</label>
                        <select name="core_no" class="form-select" onchange="this.form.submit()">
                            <option value="">Choose Core</option>
                            {% for core in core_numbers %}
                            <option value="{{ core }}" {% if core|stringformat:"i" == selected_core %}selected{% endif %}>
                                Core {{ core }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <div class="d-grid">
                        <a href="{% url 'graph_view' %}" class="btn btn-primary">Clear Selection</a>
                    </div>
                </form>
        </nav>

        {% if selected_well and selected_core %}
        <!-- Main Content -->
        <main class="col-md-9 col-lg-10 ms-sm-auto px-4 pt-3">
            <h6 class="mb-0">Core Analysis: {{ selected_well }} - Core {{ selected_core }}</h6>
            <div class="row">
                <!-- Core Analysis Chart -->
                <div class="col-md-4 col-lg-2">
                    <div class="card">
                        <div class="card-header text-white" style="background-color: #257358;">
                            <h6 class="mb-0">Prtro Analysis</h6>
                        </div>
                        <div class="card-body">
                            <div style="height: calc(100vh - 200px); width: 100%;">
                                <canvas id="coreDataChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Core Image -->
                <div class="col-md-4 col-lg-2">
                    <div class="card">
                        <div class="card-header text-white" style="background-color: #257358;">
                            <h6 class="mb-0">Core Image</h6>
                        </div>
                        <div class="card-body d-flex align-items-stretch justify-content-center" style="height: calc(100vh - 200px);">
                            {% if core_img_url %}
                            <img src="{{ core_img_url }}" alt="Core Image" style="max-height: 100%; max-width: 100%; object-fit: contain;">
                            {% else %}
                            <div class="d-flex align-items-center justify-content-center w-100">
                                <p class="text-muted">No core image available</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Litho Image -->
                <div class="col-md-4 col-lg-2">
                    <div class="card">
                        <div class="card-header text-white" style="background-color: #257358;">
                            <h6 class="mb-0">Litho Image</h6>
                        </div>
                        <div class="card-body d-flex align-items-stretch justify-content-center" style="height: calc(100vh - 200px);">
                            {% if litho_image_url %}
                            <img src="{{ litho_image_url }}" alt="Litho Image" style="max-height: 100%; max-width: 100%; object-fit: contain;">
                            {% else %}
                            <div class="d-flex align-items-center justify-content-center w-100">
                                <p class="text-muted">No litho image available</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Grain Size Analysis -->
                <div class="col-md-4 col-lg-2">
                    <div class="card">
                        <div class="card-header text-white" style="background-color: #257358;">
                            <h6 class="mb-0">Grain Size Analysis</h6>
                        </div>
                        <div class="card-body" style="height: calc(100vh - 200px); overflow-y: auto;">
                            {% if grain_size_data %}
                                <div style="height: 300px; width: 100%; margin-bottom: 20px;">
                                    <canvas id="grainSizeChart"></canvas>
                                </div>
                               <!--
                              
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Depth Range (m)</th>
                                                <th>Lithology</th>
                                                <th>Gravel %</th>
                                                <th>C.Sand %</th>
                                                <th>M.Sand %</th>
                                                <th>F.Sand %</th>
                                                <th>VF.Sand %</th>
                                                <th>Silt %</th>
                                                <th>Clay %</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in grain_size_data %}
                                            <tr>
                                                <td>{{ item.sampling_depth_start }}-{{ item.sampling_depth_end }}</td>
                                                <td>{{ item.lithology|truncatechars:15 }}</td>
                                                <td>{{ item.gravel_percent|floatformat:1|default:"-" }}</td>
                                                <td>{{ item.coarse_sand_percent|floatformat:1|default:"-" }}</td>
                                                <td>{{ item.medium_sand_percent|floatformat:1|default:"-" }}</td>
                                                <td>{{ item.fine_sand_percent|floatformat:1|default:"-" }}</td>
                                                <td>{{ item.very_fine_sand_percent|floatformat:1|default:"-" }}</td>
                                                <td>{{ item.silt_percent|floatformat:1|default:"-" }}</td>
                                                <td>{{ item.clay_percent|floatformat:1|default:"-" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                -->


                            {% else %}
                            <div class="d-flex align-items-center justify-content-center h-100">
                                <p class="text-muted">No grain size data available</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Mineralogy Analysis -->
                <div class="col-md-4 col-lg-2">
                    <div class="card">
                        <div class="card-header text-white" style="background-color: #257358;">
                            <h6 class="mb-0">Mineralogy Analysis</h6>
                        </div>
                        <div class="card-body" style="height: calc(100vh - 200px); overflow-y: auto;">
                            {% if bulk_mineralogy or clay_mineralogy %}
                                <!-- Group mineralogy data by depth range -->
                                {% regroup bulk_mineralogy by sampling_depth_start as bulk_depth_groups %}
                                {% regroup clay_mineralogy by sampling_depth_start as clay_depth_groups %}
                                
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Depth Range (m)</th>
                                                <th>Bulk Minerals</th>
                                                <th>Clay Minerals</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Process bulk mineralogy depth groups -->
                                            {% for bulk_group in bulk_depth_groups %}
                                            <tr>
                                                <td class="align-top">
                                                    <strong>{{ bulk_group.grouper }}-{{ bulk_group.list.0.sampling_depth_end }}</strong>
                                                </td>
                                                <td class="align-top">
                                                    {% for mineral in bulk_group.list %}
                                                        <div class="mb-1">
                                                            <span class="badge bg-primary me-1" style="font-size: 0.7rem;">{{ mineral.display_mineral_name|truncatechars:10 }}</span>
                                                            <small class="text-muted">{{ mineral.percentage|floatformat:1|default:"-" }}%</small>
                                                        </div>
                                                    {% endfor %}
                                                </td>
                                                <td class="align-top">
                                                    {% for clay_group in clay_depth_groups %}
                                                        {% if clay_group.grouper == bulk_group.grouper %}
                                                            {% for mineral in clay_group.list %}
                                                                <div class="mb-1">
                                                                    <span class="badge bg-success me-1" style="font-size: 0.7rem;">{{ mineral.display_mineral_name|truncatechars:10 }}</span>
                                                                    <small class="text-muted">{{ mineral.percentage|floatformat:1|default:"-" }}%</small>
                                                                </div>
                                                            {% endfor %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            
                                            <!-- Process clay-only depth groups -->
                                            {% for clay_group in clay_depth_groups %}
                                                {% with found_in_bulk=False %}
                                                    {% for bulk_group in bulk_depth_groups %}
                                                        {% if bulk_group.grouper == clay_group.grouper %}
                                                            {% with found_in_bulk=True %}
                                                            {% endwith %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% if not found_in_bulk %}
                                                    <tr>
                                                        <td class="align-top">
                                                            <strong>{{ clay_group.grouper }}-{{ clay_group.list.0.sampling_depth_end }}</strong>
                                                        </td>
                                                        <td class="align-top">
                                                            <small class="text-muted">No bulk data</small>
                                                        </td>
                                                        <td class="align-top">
                                                            {% for mineral in clay_group.list %}
                                                                <div class="mb-1">
                                                                    <span class="badge bg-success me-1" style="font-size: 0.7rem;">{{ mineral.display_mineral_name|truncatechars:10 }}</span>
                                                                    <small class="text-muted">{{ mineral.percentage|floatformat:1|default:"-" }}%</small>
                                                                </div>
                                                            {% endfor %}
                                                        </td>
                                                    </tr>
                                                    {% endif %}
                                                {% endwith %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Legend -->
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <span class="badge bg-primary me-2" style="font-size: 0.7rem;">Bulk</span>
                                        <span class="badge bg-success" style="font-size: 0.7rem;">Clay</span>
                                    </small>
                                </div>
                            {% else %}
                            <div class="d-flex align-items-center justify-content-center h-100">
                                <p class="text-muted">No mineralogy data available</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Fossils Analysis -->
                <div class="col-md-4 col-lg-2">
                    <div class="card">
                        <div class="card-header text-white" style="background-color: #257358;">
                            <h6 class="mb-0">Fossils Analysis</h6>
                        </div>
                        <div class="card-body" style="height: calc(100vh - 200px); overflow-y: auto;">
                            {% if fossils_data %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Depth Range (m)</th>
                                                <th>Type</th>
                                                <th>Species</th>
                                                <th>Abundance</th>
                                                <th>Preservation</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for fossil in fossils_data %}
                                            <tr>
                                                <td>{{ fossil.sampling_depth_start }}-{{ fossil.sampling_depth_end }}</td>
                                                <td>{{ fossil.display_fossil_type|truncatechars:10 }}</td>
                                                <td>{{ fossil.species_name|truncatechars:15|default:"-" }}</td>
                                                <td>
                                                    <span class="badge 
                                                        {% if fossil.abundance == 'very_abundant' %}bg-success
                                                        {% elif fossil.abundance == 'abundant' %}bg-primary
                                                        {% elif fossil.abundance == 'common' %}bg-info
                                                        {% elif fossil.abundance == 'few' %}bg-warning
                                                        {% elif fossil.abundance == 'rare' %}bg-secondary
                                                        {% else %}bg-light text-dark{% endif %}">
                                                        {{ fossil.get_abundance_display }}
                                                    </span>
                                                </td>
                                                <td>{{ fossil.get_preservation_display|default:"-" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Age and Environment Information -->
                                {% regroup fossils_data by age_indication as age_groups %}
                                {% if age_groups %}
                                <div class="mt-3">
                                    <h6 class="text-info">Age Indications</h6>
                                    {% for age_group in age_groups %}
                                        {% if age_group.grouper %}
                                        <div class="badge bg-info me-1 mb-1">{{ age_group.grouper }}</div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            {% else %}
                            <div class="d-flex align-items-center justify-content-center h-100">
                                <p class="text-muted">No fossils data available</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </main>

        {% else %}
        <main class="col-md-9 col-lg-10 ms-sm-auto px-4 pt-3 text-center d-flex align-items-center justify-content-center">
            <h3 class="text-muted">Please select a well and core to view data</h3>
        </main>
        {% endif %}
    </div>
</div>

{% if selected_well and selected_core %}
<script>
    // Core Data Chart (Porosity and Permeability)
    const ctx = document.getElementById('coreDataChart').getContext('2d');
    const chartData = {{ chart_data|safe }};
    
    // Calculate depth range for scaling
    const depthMin = Math.min(...chartData.depths);
    const depthMax = Math.max(...chartData.depths);
    const depthPadding = (depthMax - depthMin) * 0.01;
    
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Porosity (%)',
                data: chartData.depths.map((depth, i) => ({
                    x: chartData.porosity[i],
                    y: depth
                })),
                yAxisID: 'y',
                xAxisID: 'x1',
                backgroundColor: '#1353A3',
                borderColor: '#1353A3',
                pointRadius: 4,
                showLine: true,
                borderWidth: 1
            }, {
                label: 'Permeability (mD)',
                data: chartData.depths.map((depth, i) => ({
                    x: chartData.permeability[i],
                    y: depth
                })),
                yAxisID: 'y',
                xAxisID: 'x2',
                backgroundColor: '#CA7007',
                borderColor: '#CA7007',
                pointRadius: 4,
                showLine: true,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'nearest',
                intersect: false,
            },
            scales: {
                y: {
                    reverse: true,
                    min: depthMin - depthPadding,
                    max: depthMax + depthPadding,
                    title: {
                        display: true,
                        text: 'Depth (m)',
                        font: { size: 12, weight: 'bold' }
                    },
                    grid: { color: '#ddd' }
                },
                x1: {
                    type: 'linear',
                    position: 'top',
                    title: { display: true, text: 'Porosity (%)' },
                    ticks: { color: '#1353A3' }
                },
                x2: {
                    type: 'logarithmic',
                    position: 'bottom',
                    title: { display: true, text: 'Permeability (mD)' },
                    ticks: { color: '#CA7007' }
                }
            }
        }
    });

    // Grain Size Chart
    {% if grain_size_chart_data.depths %}
    const grainSizeCtx = document.getElementById('grainSizeChart').getContext('2d');
    const grainSizeData = {{ grain_size_chart_data|safe }};
    
    new Chart(grainSizeCtx, {
        type: 'bar',
        data: {
            labels: grainSizeData.depths,
            datasets: [
                {
                    label: 'Gravel',
                    data: grainSizeData.gravel,
                    backgroundColor: '#8B4513',
                    borderColor: '#654321',
                    borderWidth: 1
                },
                {
                    label: 'Coarse Sand',
                    data: grainSizeData.coarse_sand,
                    backgroundColor: '#DAA520',
                    borderColor: '#B8860B',
                    borderWidth: 1
                },
                {
                    label: 'Medium Sand',
                    data: grainSizeData.medium_sand,
                    backgroundColor: '#F0E68C',
                    borderColor: '#BDB76B',
                    borderWidth: 1
                },
                {
                    label: 'Fine Sand',
                    data: grainSizeData.fine_sand,
                    backgroundColor: '#FFFFE0',
                    borderColor: '#FFFACD',
                    borderWidth: 1
                },
                {
                    label: 'Very Fine Sand',
                    data: grainSizeData.very_fine_sand,
                    backgroundColor: '#F5DEB3',
                    borderColor: '#DEB887',
                    borderWidth: 1
                },
                {
                    label: 'Silt',
                    data: grainSizeData.silt,
                    backgroundColor: '#A0522D',
                    borderColor: '#8B4513',
                    borderWidth: 1
                },
                {
                    label: 'Clay',
                    data: grainSizeData.clay,
                    backgroundColor: '#8FBC8F',
                    borderColor: '#556B2F',
                    borderWidth: 1
                }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    stacked: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Percentage (%)'
                    }
                },
                y: {
                    stacked: true,
                    title: {
                        display: false,
                        text: 'Depth Range'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 10
                        }
                    }
                }
            }
        }
    });
    {% endif %}
</script>
{% endif %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}