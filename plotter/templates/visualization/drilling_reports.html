{% extends 'base.html' %}

{% block content %}
<style>
    .lithology-chart-container {
        position: relative;
        width: 100%;
        height: 60px;
        margin: 0 auto;
    }
    .well-list {
        list-style: none;
        padding: 0;
    }
    .well-list-item {
        padding: 6px 10px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 0.9rem;
    }
    .well-list-item:hover {
        background-color: rgba(255,255,255,0.1);
    }
    .well-list-item.active {
        background-color: rgba(255,255,255,0.2);
    }
    .report-card {
        margin-bottom: 0.6rem;
        transition: all 0.3s ease;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .report-card .card-header {
        cursor: pointer;
        background: linear-gradient(135deg, #257358 0%, #2d8a6a 100%);
        padding: 0.5rem 0.8rem;
        transition: all 0.2s;
        border-radius: 5px 5px 0 0;
    }
    .report-card .card-header:hover {
        background: linear-gradient(135deg, #2d8a6a 0%, #257358 100%);
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .report-card .card-body {
        display: none;
        padding: 0.7rem;
        background-color: #fafafa;
    }
    .report-card.expanded .card-body {
        display: block;
    }
    .stats-card {
        border-left: 3px solid #F59E0B;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }
    .stats-card .card-body {
        padding: 0.6rem 0.8rem;
    }
    .report-date {
        color: white !important;
        background-color: #1a5943;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        margin-right: 10px;
        display: inline-flex;
        align-items: center;
        font-weight: 600;
        box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }
    .report-date i {
        font-size: 1rem;
        margin-right: 6px;
    }
    .report-depth {
        background: linear-gradient(135deg, #E98108 0%, #d47307 100%);
        color: white !important;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        font-weight: 600;
        box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }
    .report-depth i {
        color: white !important;
        margin-right: 6px;
        font-size: 1rem;
    }
    .lithology-section {
        background-color: white;
        padding: 10px;
        border-radius: 6px;
        margin-top: 0;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .chevron-icon {
        transition: transform 0.3s ease;
        color: white;
        font-size: 1.2rem;
        opacity: 0.9;
    }
    .report-card.expanded .chevron-icon {
        transform: rotate(180deg);
    }
    .info-row {
        margin-bottom: 8px;
        padding: 5px 8px;
        background-color: white;
        border-radius: 4px;
        border-left: 2px solid #257358;
        font-size: 0.9rem;
    }
    .info-row strong {
        color: #257358;
        min-width: 130px;
        display: inline-block;
        font-size: 0.88rem;
    }
    .lithology-legend {
        background-color: #f8f9fa;
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 10px;
        border: 1px solid #dee2e6;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 12px;
        margin-bottom: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .legend-color {
        display: inline-block;
        width: 16px;
        height: 16px;
        margin-right: 6px;
        border-radius: 3px;
        border: 1px solid rgba(0,0,0,0.1);
    }
    .depth-label {
        background-color: #e9ecef;
        padding: 5px 8px;
        border-radius: 4px;
        font-weight: 600;
        color: #495057;
        font-size: 0.85rem;
    }
    .lithology-entry {
        padding: 8px;
        background-color: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 6px;
        border: 1px solid #e0e0e0;
    }
    .info-section {
        background-color: white;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    .info-section h6 {
        font-size: 0.95rem;
        margin-bottom: 8px !important;
    }
    .lithology-section h6 {
        font-size: 0.95rem;
        margin-bottom: 8px !important;
    }
    /* Prognosis styles */
    .prognosis-bar-v { display: flex; flex-direction: column; width: 150px; height: 100%; border-radius: 6px; overflow: hidden; border: 1px solid #e0e0e0; }
    .prognosis-segment { height: 100%; position: relative; }
    .prognosis-segment:hover::after { content: attr(data-tooltip); position: absolute; left: 42px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 3px 6px; border-radius: 3px; white-space: nowrap; font-size: 11px; z-index: 2; }
    .prognosis-legend .legend-item { display: inline-flex; align-items: center; margin-right: 10px; margin-bottom: 4px; font-size: 0.82rem; }
    .prognosis-legend .legend-color { width: 12px; height: 12px; border-radius: 2px; display: inline-block; margin-right: 5px; border: 1px solid rgba(0,0,0,0.1); }
    .prognosis-depth-labels-v { display: flex; flex-direction: column; justify-content: space-between; margin-left: 6px; font-size: 11px; color: #6c757d; }
    .prognosis-tick { position: relative; display: flex; align-items: center; gap: 4px; }
    .prognosis-tick-line { width: 6px; height: 1px; background: #adb5bd; display: inline-block; }
    .prognosis-target { outline: 2px dashed rgba(0,0,0,0.25); outline-offset: -2px; }
    .prognosis-wrap { display: flex; align-items: stretch; gap: 8px; }
    .sidebar { padding: 0.8rem !important; }
    .sidebar .card-header { padding: 10px !important; }
    .sidebar h5 { font-size: 1rem !important; margin-bottom: 0 !important; }
    h1.display-5 { font-size: 1.5rem; margin-bottom: 0.8rem !important; }
    .stats-card h6 { font-size: 0.82rem; margin-bottom: 2px !important; }
    .stats-card h4 { font-size: 1.3rem; }
    .row.mb-3 { margin-bottom: 0.8rem !important; }
    .col-md-3 { padding-left: 6px; padding-right: 6px; }
    main.px-4 { padding-left: 1rem !important; padding-right: 1rem !important; }
    main.pt-3 { padding-top: 0.8rem !important; }
    .card.mb-3 { margin-bottom: 0.8rem !important; }
    .position-sticky .card .card-body { padding: 0.8rem; }
    .position-sticky h6 { font-size: 0.9rem; margin-bottom: 6px !important; }
</style>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar" style="background-color: #257358; color: white; min-height: 100vh;">
            <div class="card-header text-white" style="background-color: #1a5943; border-radius: 6px;">
                <h5 style="color: #E98108; font-weight: 600;">
                    <i class="bi bi-layers me-2"></i>Available Wells
                </h5>
            </div>
            <ul class="well-list mt-2">
                {% for well in wells %}
                    <li class="well-list-item {% if well.id|stringformat:'s' == selected_well %}active{% endif %}">
                        <a href="?well={{ well.id }}" class="text-white text-decoration-none">
                            <i class="bi bi-pin-angle-fill me-2"></i>{{ well.name }}
                        </a>
                    </li>
                {% empty %}
                    <li class="text-white-50 p-2">No wells available</li>
                {% endfor %}
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 col-lg-10 ms-sm-auto px-4 pt-3">
            {% if selected_well %}
            <div class="row g-2">
                <div class="col-lg-9 col-xl-9">
            <div class="mb-3">
                <h1 class="display-5 fw-bold">
                    {% for well in wells %}
                        {% if well.id|stringformat:'s' == selected_well %}
                            <span class="text-muted" style="font-size: 0.65em;"> {{ well.name }} Drilling Reports</span>
                        {% endif %} 
                    {% endfor %}
                </h1>
            </div>
            
            <!-- Statistics Cards -->
            {% if stats %}
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-1">
                                <i class="bi bi-file-earmark-text me-1"></i>Total Reports
                            </h6>
                            <h4 class="card-text mb-0" style="color: #257358; font-weight: 700;">{{ stats.total_reports }}</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-1">
                                <i class="bi bi-arrow-down-circle me-1"></i>Total Depth Progress
                            </h6>
                            <h4 class="card-text mb-0" style="color: #257358; font-weight: 700;">{{ stats.depth_progress|floatformat:1 }} m</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-1">
                                <i class="bi bi-geo-alt me-1"></i>Latest Depth
                            </h6>
                            <h4 class="card-text mb-0" style="color: #257358; font-weight: 700;">{{ stats.latest_depth|floatformat:1 }} m</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-1">
                                <i class="bi bi-speedometer2 me-1"></i>Avg. Progress/Day
                            </h6>
                            <h4 class="card-text mb-0" style="color: #257358; font-weight: 700;">{{ stats.avg_progress_per_day|floatformat:1 }} m</h4>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Reports Cards -->
            <div class="reports-container">
                {% for report in reports %}
                <div class="card report-card" data-report-id="{{ report.id }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center flex-wrap">
                            <span class="report-date">
                                <i class="bi bi-calendar-check"></i>{{ report.date}}
                            </span>
                            <span class="report-depth">
                                <i class="bi bi-arrows-expand"></i>{{ report.depth_start|floatformat:1 }} - {{ report.depth_end|floatformat:1 }} m
                            </span>
                            {% with report_date=report.date|date:'Y-m-d' %}
                            <a href="{% url 'generate_drilling_reports_pdf' %}?well={{ selected_well }}&date={{ report.date_iso }}" 
                                class="btn btn-sm btn-outline-light ms-2" 
                                target="_blank"
                                style="background-color: #570505; padding: 3px 8px; font-size: 0.85rem;"
                                title="Download PDF Report for {{ report.date }}">
                                <i class="bi bi-file-pdf"></i>
                            </a>
                            {% endwith %}
                        </div>
                        <i class="bi bi-chevron-down chevron-icon"></i>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-section">
                                    <h6 style="color: #257358; font-weight: 600;">
                                        <i class="bi bi-info-circle me-2"></i>Report Details
                                    </h6>
                                    <div class="info-row">
                                        <strong><i class="bi bi-cloud me-1"></i>Present Activity</strong> 
                                        <span>{{ report.present_activity|default:"Not specified"|safe }}</span>
                                    </div>
                                    <div class="info-row">
                                        <strong><i class="bi bi-gear me-1"></i>Drilling Operation:</strong> 
                                        <span>{{ report.current_operation|default:"Not specified"|safe }}</span>
                                    </div>
                                    <div class="info-row">
                                        <strong><i class="bi bi-cloud me-1"></i>Gas Show:</strong> 
                                        <span>{{ report.gas_show|default:"None" }}</span>
                                    </div>
                                    <div class="info-row">
                                        <strong><i class="bi bi-chat-left-text me-1"></i>Comments:</strong> 
                                        <span>{{ report.comments|default:"No comments"|safe }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="lithology-section">
                                    <h6 style="color: #257358; font-weight: 600;">
                                        <i class="bi bi-layers-fill me-2"></i>Lithology Compositions
                                    </h6>
                                    
                                    {% if report.lithologies %}
                                    <div class="lithology-legend">
                                        <div class="d-flex flex-wrap justify-content-center">
                                            <span class="legend-item">
                                                <span class="legend-color" style="background:#666666;"></span>
                                                Shale
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background:#FFD700;"></span>
                                                Sand
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background:#CD853F;"></span>
                                                Clay
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background:#DEB887;"></span>
                                                Silt
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% for lithology in report.lithologies %}
                                    <div class="lithology-entry">
                                        <div class="d-flex align-items-center">
                                            <div class="lithology-chart-container me-2" style="flex-grow: 1;">
                                                <canvas class="lithologyChartRow"
                                                    id="chart-{{ report.id }}-{{ forloop.counter }}"
                                                    data-shale="{{ lithology.shale }}"
                                                    data-sand="{{ lithology.sand }}"
                                                    data-clay="{{ lithology.clay }}"
                                                    data-slit="{{ lithology.slit }}"
                                                    data-depth-range="{{ lithology.depth_range }}">
                                                </canvas>
                                            </div>
                                            <div class="depth-label" style="min-width: 110px; text-align: right; background: none; padding: 3px 6px;">
                                                <span class="badge bg-secondary" style="font-size: 0.6rem;">
                                                    <i class="bi bi-arrows-collapse-vertical me-1"></i>
                                                    {{ lithology.depth_range }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="mt-1 ms-1">
                                            <small style="font-size: 0.85rem;"><strong>Dominant Lithology:</strong> {{ lithology.dominant_lithology|title }} ({{ lithology.dominant_percentage }}%)</small>
                                        </div>
                                        {% if lithology.prognosis_comparison %}
                                        <div class="mt-1 ms-1">
                                            <div class="alert alert-{{ lithology.comparison_type }} py-1 mb-0" style="font-size: 0.82em;">
                                                <i class="bi {% if lithology.comparison_type == 'success' %}bi-check-circle{% elif lithology.comparison_type == 'warning' %}bi-exclamation-triangle{% else %}bi-info-circle{% endif %} me-1"></i>
                                                <strong>Prognosis:</strong> {{ lithology.prognosis_comparison }}
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% if lithology.description %}
                                        <div class="mt-1 ms-1">
                                            <small class="text-muted" style="font-size: 0.82rem;"><i class="bi bi-file-text me-1"></i>{{ lithology.description }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="alert alert-light text-center py-2" role="alert" style="font-size: 0.9rem;">
                                        <i class="bi bi-exclamation-circle me-2"></i>No lithology data available for this interval
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>No drilling reports found for this well.
                </div>
                {% endfor %}
            </div>
                </div>
                <aside class="col-lg-3 col-xl-3">
                    {% if prognosis_segments %}
                    <div class="position-sticky" style="top: 0.8rem;">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0" style="color: #257358; font-weight: 600;">
                                        <i class="bi bi-layers me-1"></i>Prognosis Lithology
                                    </h6>
                                    {% if prognosis_range %}
                                    <span class="text-muted" style="font-size: 0.8rem;">{{ prognosis_range.min }} - {{ prognosis_range.max }} m</span>
                                    {% endif %}
                                </div>
                                <div class="prognosis-legend mb-2">
                                    <span class="legend-item"><span class="legend-color" style="background:#FFD700;"></span> Sand</span>
                                    <span class="legend-item"><span class="legend-color" style="background:#CD853F;"></span> Clay</span>
                                    <span class="legend-item"><span class="legend-color" style="background:#666666;"></span> Shale</span>
                                    <span class="legend-item"><span class="legend-color" style="background:#DEB887;"></span> Silt</span>
                                    <span class="legend-item"><span class="legend-color" style="background:#a10c07;"></span> Target</span>
                                </div>
                                <div class="prognosis-wrap" id="prognosis-wrap">
                                    <div class="prognosis-bar-v" aria-label="Prognosis lithology by depth (vertical)" id="prognosis-bar">
                                        {% if prognosis_range and prognosis_range.top_spacer_pct and prognosis_range.top_spacer_pct > 0 %}
                                            <div class="prognosis-spacer" data-height="{{ prognosis_range.top_spacer_pct }}"></div>
                                        {% endif %}
                                        {% for seg in prognosis_segments %}
                                            <div class="prognosis-segment {% if seg.is_target %}prognosis-target{% endif %}"
                                                 data-height="{{ seg.height_pct }}"
                                                 data-color="{% if seg.is_target %}#a10c07{% elif seg.lithology == 'sand' %}#FFD700{% elif seg.lithology == 'clay' %}#CD853F{% elif seg.lithology == 'shale' %}#666666{% elif seg.lithology == 'slit' %}#DEB887{% else %}#9aa0a6{% endif %}"
                                                 data-tooltip="{{ seg.label }} â€¢ {{ seg.lithology|title }}">
                                            </div>
                                        {% endfor %}
                                    </div>
                                    {% if prognosis_range %}
                                    <div class="prognosis-depth-labels-v" aria-hidden="true" id="prognosis-ticks"
                                         data-min="{{ prognosis_range.min }}" data-max="{{ prognosis_range.max }}">
                                    </div>
                                    {% endif %}
                                </div>
                                <script>
                                    (function(){
                                        const wrap = document.getElementById('prognosis-wrap');
                                        const bar = document.getElementById('prognosis-bar');
                                        const ticks = document.getElementById('prognosis-ticks');
                                        if (!bar) return;
                                        bar.querySelectorAll('.prognosis-spacer, .prognosis-segment').forEach(el => {
                                            const h = parseFloat(el.getAttribute('data-height'));
                                            if (!isNaN(h)) el.style.height = h + '%';
                                            const color = el.getAttribute('data-color');
                                            if (color) el.style.background = color;
                                        });

                                        function computeBarHeight() {
                                            try {
                                                const card = bar.closest('.card');
                                                const rectTop = card.getBoundingClientRect().top;
                                                const topOffset = Math.max(rectTop, 0);
                                                const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                                                const targetHeight = Math.max(viewportHeight - 24 - (rectTop - topOffset), 280);
                                                bar.style.height = targetHeight + 'px';
                                                if (ticks) ticks.style.height = targetHeight + 'px';
                                            } catch(e) { /* noop */ }
                                        }

                                        function niceStep(max) {
                                            if (!max || max <= 0) return 50;
                                            const raw = max / 12;
                                            const candidates = [10, 20, 25, 50, 100, 200, 250, 500, 1000];
                                            let best = candidates[0];
                                            for (const c of candidates) {
                                                if (raw <= c) { best = c; break; }
                                                best = c;
                                            }
                                            return best;
                                        }

                                        function buildTicks() {
                                            if (!ticks) return;
                                            const min = parseFloat(ticks.getAttribute('data-min')) || 0;
                                            const max = parseFloat(ticks.getAttribute('data-max')) || 0;
                                            const step = niceStep(max);
                                            const labels = [];
                                            const start = Math.max(0, Math.floor(min / step) * step);
                                            for (let v = start; v <= max; v += step) labels.push(v);
                                            if (labels[0] !== 0) labels.unshift(0);
                                            if (labels[labels.length - 1] !== max) labels.push(max);
                                            ticks.innerHTML = '';
                                            labels.forEach((value, idx) => {
                                                const row = document.createElement('div');
                                                row.className = 'prognosis-tick';
                                                const line = document.createElement('span');
                                                line.className = 'prognosis-tick-line';
                                                const label = document.createElement('span');
                                                label.textContent = value + ' m';
                                                row.appendChild(line);
                                                row.appendChild(label);
                                                ticks.appendChild(row);
                                            });
                                        }

                                        computeBarHeight();
                                        buildTicks();
                                        window.addEventListener('resize', computeBarHeight);
                                    })();
                                </script>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </aside>
            </div>
            {% else %}
            <div class="text-center mt-5">
                <i class="bi bi-inbox" style="font-size: 3.5rem; color: #257358;"></i>
                <h3 class="mt-3" style="font-size: 1.3rem;">Select a well from the left sidebar</h3>
                <p class="text-muted" style="font-size: 0.95rem;">Drilling reports will be displayed here, sorted by date with the most recent on top.</p>
            </div>
            {% endif %}
        </main>
    </div>
</div>
<script>
class DrillingReportsVisualizer {
    constructor() {
        this.chartInstances = new Map();
        this.initializeEventListeners();
    }

    initializeEventListeners() {
        document.querySelectorAll('.report-card .card-header').forEach(header => {
            header.addEventListener('click', (e) => this.handleCardClick(e));
        });

        this.expandFirstCard();
    }

    handleCardClick(event) {
        const header = event.currentTarget;
        const card = header.closest('.report-card');
        const wasExpanded = card.classList.contains('expanded');

        document.querySelectorAll('.report-card').forEach(c => {
            if (c !== card) {
                c.classList.remove('expanded');
                c.querySelectorAll('.lithologyChartRow').forEach(canvas => {
                    const chartId = canvas.id;
                    if (this.chartInstances.has(chartId)) {
                        this.chartInstances.get(chartId).destroy();
                        this.chartInstances.delete(chartId);
                    }
                });
            }
        });

        if (!wasExpanded) {
            card.classList.add('expanded');
            this.renderChartsInCard(card);
        } else {
            card.classList.remove('expanded');
        }
    }

    renderChartsInCard(card) {
        setTimeout(() => {
            card.querySelectorAll('.lithologyChartRow').forEach(canvas => {
                if (!this.chartInstances.has(canvas.id)) {
                    this.renderLithologyChart(canvas);
                }
            });
        }, 50);
    }

    renderLithologyChart(canvas) {
        if (!canvas || !canvas.getContext('2d')) return;

        const ctx = canvas.getContext('2d');
        const data = this.getLithologyData(canvas);

        if (this.chartInstances.has(canvas.id)) {
            this.chartInstances.get(canvas.id).destroy();
        }

        const chart = new Chart(ctx, this.getChartConfig(data));
        this.chartInstances.set(canvas.id, chart);
    }

    getLithologyData(canvas) {
        const data = {
            shale: parseFloat(canvas.dataset.shale) || 0,
            sand: parseFloat(canvas.dataset.sand) || 0,
            clay: parseFloat(canvas.dataset.clay) || 0,
            slit: parseFloat(canvas.dataset.slit) || 0,
            depthRange: canvas.dataset.depthRange || ''
        };

        ['shale', 'sand', 'clay', 'slit'].forEach(key => {
            if (isNaN(data[key])) data[key] = 0;
            data[key] = parseFloat(data[key].toFixed(1));
        });

        return data;
    }

    getChartConfig(data) {
        return {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [
                    {
                        label: 'Shale',
                        data: [data.shale],
                        backgroundColor: '#666666',
                        borderColor: '#444444',
                        borderWidth: 0
                    },
                    {
                        label: 'Sand',
                        data: [data.sand],
                        backgroundColor: '#FFD700',
                        borderColor: '#B8860B',
                        borderWidth: 0
                    },
                    {
                        label: 'Clay',
                        data: [data.clay],
                        backgroundColor: '#CD853F',
                        borderColor: '#8B4513',
                        borderWidth: 0
                    },
                    {
                        label: 'Silt',
                        data: [data.slit],
                        backgroundColor: '#DEB887',
                        borderColor: '#D2691E',
                        borderWidth: 0
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 2,
                        right: 2,
                        top: 2,
                        bottom: 2
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 10,
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.raw.toFixed(1)}%`
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        max: 100,
                        min: 0,
                        ticks: {
                            display: true,
                            font: {
                                size: 8,
                                weight: '400'
                            },
                            maxRotation: 0,
                            autoSkip: true,
                            autoSkipPadding: 12,
                            callback: (value) => value + '%'
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.08)'
                        }
                    },
                    y: {
                        stacked: true,
                        display: false,
                        grid: { display: false }
                    }
                },
                animation: { 
                    duration: 400,
                    easing: 'easeInOutQuart'
                }
            }
        };
    }

    expandFirstCard() {
        const firstCard = document.querySelector('.report-card');
        if (firstCard) {
            firstCard.classList.add('expanded');
            setTimeout(() => {
                this.renderChartsInCard(firstCard);
            }, 100);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded! Make sure the CDN is accessible.');
        return;
    }
    
    new DrillingReportsVisualizer();
});
</script>
{% endblock %}