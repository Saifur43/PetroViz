{% extends 'base.html' %}

{% block content %}
<style>
    .lithology-chart-container {
        position: relative;
        width: 100%;
        height: 100px;
        margin: 0 auto;
    }
    .well-list {
        list-style: none;
        padding: 0;
    }
    .well-list-item {
        padding: 10px 15px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .well-list-item:hover {
        background-color: rgba(255,255,255,0.1);
    }
    .well-list-item.active {
        background-color: rgba(255,255,255,0.2);
    }
    .report-card {
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .report-card .card-header {
        cursor: pointer;
        background: linear-gradient(135deg, #257358 0%, #2d8a6a 100%);
        padding: 1.25rem;
        transition: all 0.2s;
        border-radius: 6px 6px 0 0;
    }
    .report-card .card-header:hover {
        background: linear-gradient(135deg, #2d8a6a 0%, #257358 100%);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .report-card .card-body {
        display: none;
        padding: 1.5rem;
        background-color: #fafafa;
    }
    .report-card.expanded .card-body {
        display: block;
    }
    .stats-card {
        border-left: 4px solid #F59E0B;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .report-date {
        color: white !important;
        background-color: #1a5943;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 1.1rem;
        margin-right: 15px;
        display: inline-flex;
        align-items: center;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        letter-spacing: 0.3px;
    }
    .report-date i {
        font-size: 1.2rem;
        margin-right: 8px;
    }
    .report-depth {
        background: linear-gradient(135deg, #E98108 0%, #d47307 100%);
        color: white !important;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 1.1rem;
        display: inline-flex;
        align-items: center;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        letter-spacing: 0.3px;
    }
    .report-depth i {
        color: white !important;
        margin-right: 8px;
        font-size: 1.2rem;
    }
    .lithology-section {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .chevron-icon {
        transition: transform 0.3s ease;
        color: white;
        font-size: 1.4rem;
        opacity: 0.9;
    }
    .report-card.expanded .chevron-icon {
        transform: rotate(180deg);
    }
    .info-row {
        margin-bottom: 15px;
        padding: 10px;
        background-color: white;
        border-radius: 6px;
        border-left: 3px solid #257358;
    }
    .info-row strong {
        color: #257358;
        min-width: 150px;
        display: inline-block;
        font-size: 0.95rem;
    }
    .lithology-legend {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 20px;
        margin-bottom: 8px;
        font-size: 0.95rem;
        font-weight: 500;
    }
    .legend-color {
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.1);
    }
    .depth-label {
        background-color: #e9ecef;
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 600;
        color: #495057;
    }
    .lithology-entry {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid #e0e0e0;
    }
    .info-section {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
</style>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar p-3" style="background-color: #257358; color: white; min-height: 100vh;">
            <div class="card-header text-white" style="background-color: #1a5943; border-radius: 8px; padding: 15px;">
                <h5 class="mb-0" style="color: #E98108; font-weight: 600;">
                    <i class="bi bi-layers me-2"></i>Available Wells
                </h5>
            </div>
            <ul class="well-list mt-3">
                {% for well in wells %}
                    <li class="well-list-item {% if well.id|stringformat:'s' == selected_well %}active{% endif %}">
                        <a href="?well={{ well.id }}" class="text-white text-decoration-none">
                            <i class="bi bi-pin-angle-fill me-2"></i>{{ well.name }}
                        </a>
                    </li>
                {% empty %}
                    <li class="text-white-50 p-3">No wells available</li>
                {% endfor %}
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 col-lg-10 ms-sm-auto px-4 pt-3">
            {% if selected_well %}
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="display-5 fw-bold">
                        <div class="d-flex align-items-center">
                            {% for well in wells %}
                                {% if well.id|stringformat:'s' == selected_well %}
                                    <span class="text-muted" style="font-size: 0.6em;"> {{ well.name }} Drilling Reports</span>
                                {% endif %} 
                            {% endfor %}
                        </div>
                    </h1>
                </div>
            </div>
            <!-- Statistics Cards -->
            {% if stats %}
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-2">
                                <i class="bi bi-file-earmark-text me-2"></i>Total Reports
                            </h6>
                            <h3 class="card-text mb-0" style="color: #257358; font-weight: 700;">{{ stats.total_reports }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-2">
                                <i class="bi bi-arrow-down-circle me-2"></i>Total Depth Progress
                            </h6>
                            <h3 class="card-text mb-0" style="color: #257358; font-weight: 700;">{{ stats.depth_progress|floatformat:1 }} m</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-2">
                                <i class="bi bi-geo-alt me-2"></i>Latest Depth
                            </h6>
                            <h3 class="card-text mb-0" style="color: #257358; font-weight: 700;">{{ stats.latest_depth|floatformat:1 }} m</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-2">
                                <i class="bi bi-speedometer2 me-2"></i>Avg. Progress/Day
                            </h6>
                            <h3 class="card-text mb-0" style="color: #257358; font-weight: 700;">{{ stats.avg_progress_per_day|floatformat:1 }} m</h3>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Reports Cards -->
            <div class="reports-container">
                {% for report in reports %}
                <div class="card report-card mb-3" data-report-id="{{ report.id }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center flex-wrap">
                            <span class="report-date">
                                <i class="bi bi-calendar-check"></i>{{ report.date}}
                            </span>
                            <span class="report-depth">
                                <i class="bi bi-arrows-expand"></i>{{ report.depth_start|floatformat:1 }} - {{ report.depth_end|floatformat:1 }} m
                            </span>
                            {% with report_date=report.date|date:'Y-m-d' %}
                            <a href="{% url 'generate_drilling_reports_pdf' %}?well={{ selected_well }}&date={{ report.date_iso }}" 
                                class="btn btn-sm btn-outline-light ms-3" 
                                target="_blank"
                                style="background-color: #570505 ;"
                                title="Download PDF Report for {{ report.date }}">
                                <i class="bi bi-file-pdf"></i>
                            </a>
                            {% endwith %}
                        </div>
                        <i class="bi bi-chevron-down chevron-icon"></i>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-section">
                                    <h6 class="mb-3" style="color: #257358; font-weight: 600; font-size: 1.1rem;">
                                        <i class="bi bi-info-circle me-2"></i>Report Details
                                    </h6>
                                    <div class="info-row">
                                        <strong><i class="bi bi-gear me-2"></i>Current Operation:</strong> 
                                        <span>{{ report.current_operation|default:"Not specified"|safe }}</span>
                                    </div>
                                    <div class="info-row">
                                        <strong><i class="bi bi-cloud me-2"></i>Gas Show:</strong> 
                                        <span>{{ report.gas_show|default:"None" }}</span>
                                    </div>
                                    <div class="info-row">
                                        <strong><i class="bi bi-chat-left-text me-2"></i>Comments:</strong> 
                                        <span>{{ report.comments|default:"No comments"|safe }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="lithology-section">
                                    <h6 class="mb-3" style="color: #257358; font-weight: 600; font-size: 1.1rem;">
                                        <i class="bi bi-layers-fill me-2"></i>Lithology Compositions
                                    </h6>
                                    
                                    <!-- Single Legend for All Charts -->
                                    {% if report.lithologies %}
                                    <div class="lithology-legend">
                                        <div class="d-flex flex-wrap justify-content-center">
                                            <span class="legend-item">
                                                <span class="legend-color" style="background:#666666;"></span>
                                                Shale
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background:#FFD700;"></span>
                                                Sand
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background:#CD853F;"></span>
                                                Clay
                                            </span>
                                            <span class="legend-item">
                                                <span class="legend-color" style="background:#DEB887;"></span>
                                                Silt
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    {% for lithology in report.lithologies %}
                                    <div class="lithology-entry py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="lithology-chart-container me-2" style="height: 50px; flex-grow: 1;">
                                                <canvas class="lithologyChartRow"
                                                    id="chart-{{ report.id }}-{{ forloop.counter }}"
                                                    data-shale="{{ lithology.shale }}"
                                                    data-sand="{{ lithology.sand }}"
                                                    data-clay="{{ lithology.clay }}"
                                                    data-slit="{{ lithology.slit }}"
                                                    data-depth-range="{{ lithology.depth_range }}">
                                                </canvas>
                                            </div>
                                            <div class="depth-label" style="min-width: 120px; text-align: right; background: none; padding: 4px 8px;">
                                                <span class="badge bg-secondary">
                                                    <i class="bi bi-arrows-collapse-vertical me-1"></i>
                                                    {{ lithology.depth_range }}
                                                </span>
                                            </div>
                                        </div>
                                        {% if lithology.description %}
                                        <div class="mt-1 ms-2">
                                            <small class="text-muted"><i class="bi bi-file-text me-1"></i>{{ lithology.description }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% empty %}
                                    <div class="alert alert-light text-center" role="alert">
                                        <i class="bi bi-exclamation-circle me-2"></i>No lithology data available for this interval
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>No drilling reports found for this well.
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center mt-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #257358;"></i>
                <h3 class="mt-3">Select a well from the left sidebar</h3>
                <p class="text-muted">Drilling reports will be displayed here, sorted by date with the most recent on top.</p>
            </div>
            {% endif %}
        </main>
    </div>
</div>
<script>
class DrillingReportsVisualizer {
    constructor() {
        this.chartInstances = new Map();
        this.initializeEventListeners();
    }

    initializeEventListeners() {
        document.querySelectorAll('.report-card .card-header').forEach(header => {
            header.addEventListener('click', (e) => this.handleCardClick(e));
        });

        this.expandFirstCard();
    }

    handleCardClick(event) {
        const header = event.currentTarget;
        const card = header.closest('.report-card');
        const wasExpanded = card.classList.contains('expanded');

        document.querySelectorAll('.report-card').forEach(c => {
            if (c !== card) {
                c.classList.remove('expanded');
                c.querySelectorAll('.lithologyChartRow').forEach(canvas => {
                    const chartId = canvas.id;
                    if (this.chartInstances.has(chartId)) {
                        this.chartInstances.get(chartId).destroy();
                        this.chartInstances.delete(chartId);
                    }
                });
            }
        });

        if (!wasExpanded) {
            card.classList.add('expanded');
            this.renderChartsInCard(card);
        } else {
            card.classList.remove('expanded');
        }
    }

    renderChartsInCard(card) {
        setTimeout(() => {
            card.querySelectorAll('.lithologyChartRow').forEach(canvas => {
                if (!this.chartInstances.has(canvas.id)) {
                    this.renderLithologyChart(canvas);
                }
            });
        }, 50);
    }

    renderLithologyChart(canvas) {
        if (!canvas || !canvas.getContext('2d')) return;

        const ctx = canvas.getContext('2d');
        const data = this.getLithologyData(canvas);

        if (this.chartInstances.has(canvas.id)) {
            this.chartInstances.get(canvas.id).destroy();
        }

        const chart = new Chart(ctx, this.getChartConfig(data));
        this.chartInstances.set(canvas.id, chart);
    }

    getLithologyData(canvas) {
        const data = {
            shale: parseFloat(canvas.dataset.shale) || 0,
            sand: parseFloat(canvas.dataset.sand) || 0,
            clay: parseFloat(canvas.dataset.clay) || 0,
            slit: parseFloat(canvas.dataset.slit) || 0,
            depthRange: canvas.dataset.depthRange || ''
        };

        ['shale', 'sand', 'clay', 'slit'].forEach(key => {
            if (isNaN(data[key])) data[key] = 0;
            data[key] = parseFloat(data[key].toFixed(1));
        });

        return data;
    }

    getChartConfig(data) {
        return {
            type: 'bar',
            data: {
                labels: [''],
                datasets: [
                    {
                        label: 'Shale',
                        data: [data.shale],
                        backgroundColor: '#666666',
                        borderColor: '#444444',
                        borderWidth: 0
                    },
                    {
                        label: 'Sand',
                        data: [data.sand],
                        backgroundColor: '#FFD700',
                        borderColor: '#B8860B',
                        borderWidth: 0
                    },
                    {
                        label: 'Clay',
                        data: [data.clay],
                        backgroundColor: '#CD853F',
                        borderColor: '#8B4513',
                        borderWidth: 0
                    },
                    {
                        label: 'Silt',
                        data: [data.slit],
                        backgroundColor: '#DEB887',
                        borderColor: '#D2691E',
                        borderWidth: 0
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 2,
                        right: 2,
                        top: 2,
                        bottom: 2
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: { size: 14, weight: 'bold' },
                        bodyFont: { size: 13 },
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.raw.toFixed(1)}%`
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        max: 100,
                        min: 0,
                        ticks: {
                            display: true,
                            font: {
                                size: 10,
                                weight: '400'
                            },
                            maxRotation: 0,
                            autoSkip: true,
                            autoSkipPadding: 15,
                            callback: (value) => value + '%'
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.08)'
                        }
                    },
                    y: {
                        stacked: true,
                        display: false,
                        grid: { display: false }
                    }
                },
                animation: { 
                    duration: 400,
                    easing: 'easeInOutQuart'
                }
            }
        };
    }

    expandFirstCard() {
        const firstCard = document.querySelector('.report-card');
        if (firstCard) {
            firstCard.classList.add('expanded');
            setTimeout(() => {
                this.renderChartsInCard(firstCard);
            }, 100);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded! Make sure the CDN is accessible.');
        return;
    }
    
    new DrillingReportsVisualizer();
});
</script>
{% endblock %}